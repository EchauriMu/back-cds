# Diagrama de Flujo: Estructura Estandarizada

## ๐ Flujo Completo de una Request

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         CLIENT REQUEST                           โ
โ  POST /api/ztpromociones/crudPromociones                        โ
โ  ?ProcessType=GetFilters&LoggedUser=jlopezm&DBServer=MongoDB   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CONTROLLER LAYER                              โ
โ                 (ztpromociones-controller.js)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 1: Extraer Parรกmetros                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโ                                      โ
โ  โข ProcessType  โ req.req.query.ProcessType                     โ
โ  โข LoggedUser   โ req.req.query.LoggedUser                      โ
โ  โข DBServer     โ req.req.query.DBServer || 'MongoDB'           โ
โ  โข method       โ req.req.method || 'POST'                      โ
โ  โข api          โ '/api/ztpromociones/crudPromociones'          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 2: Validar Campos Obligatorios                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                            โ
โ                                                                  โ
โ  if (!ProcessType) {                                            โ
โ    throw Error('Parรกmetro obligatorio: ProcessType') โ 400     โ
โ  }                                                               โ
โ                                                                  โ
โ  if (!LoggedUser) {                                             โ
โ    throw Error('Parรกmetro obligatorio: LoggedUser') โ 400      โ
โ  }                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 3: Validar Formato de LoggedUser                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                         โ
โ                                                                  โ
โ  regex = /^[a-z][a-z]+[a-z]$/i                                  โ
โ                                                                  โ
โ  if (!regex.test(LoggedUser)) {                                 โ
โ    console.warn('LoggedUser con formato inusual')               โ
โ  }                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 4: Log de Contexto (solo development)                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                     โ
โ                                                                  โ
โ  if (process.env.NODE_ENV === 'development') {                  โ
โ    console.log('[ZTPROMOCIONES] Contexto:');                    โ
โ    console.log(`  - ProcessType: ${ProcessType}`);              โ
โ    console.log(`  - LoggedUser: ${LoggedUser}`);                โ
โ    console.log(`  - DBServer: ${DBServer}`);                    โ
โ  }                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      SERVICE LAYER                               โ
โ                 (ztpromociones-service.js)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 5: Configurar Bitรกcora                                    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโ                                        โ
โ                                                                  โ
โ  bitacora.processType = ProcessType                             โ
โ  bitacora.loggedUser  = LoggedUser                              โ
โ  bitacora.dbServer    = DBServer                                โ
โ  bitacora.method      = method                                  โ
โ  bitacora.api         = api                                     โ
โ  bitacora.server      = process.env.SERVER_NAME                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 6: Ejecutar segรบn ProcessType                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                            โ
โ                                                                  โ
โ  switch (ProcessType) {                                         โ
โ    case 'GetFilters':                                           โ
โ      โ GetFiltersPromocionesMethod()                            โ
โ    case 'AddMany':                                              โ
โ      โ AddManyPromocionesMethod()                               โ
โ    case 'UpdateMany':                                           โ
โ      โ UpdateManyPromocionesMethod()                            โ
โ    case 'DeleteMany':                                           โ
โ      โ DeleteManyPromocionesMethod()                            โ
โ  }                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 7: Conectar a Base de Datos                               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                               โ
โ                                                                  โ
โ  switch (DBServer) {                                            โ
โ    case 'MongoDB':                                              โ
โ      โ mongoose.connect()                                       โ
โ    case 'HANA':                                                 โ
โ      โ throw Error('No implementado')                           โ
โ    case 'AzureCosmos':                                          โ
โ      โ throw Error('No implementado')                           โ
โ  }                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 8: Ejecutar Operaciรณn CRUD                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ                                                                  โ
โ  โข GetFilters  โ ZTPromociones.find()                           โ
โ  โข AddMany     โ saveWithAudit() / insertMany()                 โ
โ  โข UpdateMany  โ saveWithAudit() / updateMany()                 โ
โ  โข DeleteMany  โ saveWithAudit() / deleteMany()                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 9: Registrar en Bitรกcora                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโ                                      โ
โ                                                                  โ
โ  data.dataRes = result                                          โ
โ  data.messageUSR = 'Operaciรณn exitosa'                          โ
โ  data.messageDEV = 'Detalles tรฉcnicos...'                       โ
โ  bitacora = AddMSG(bitacora, data, 'OK', 200, true)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    BACK TO CONTROLLER                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 10: Configurar HTTP Status                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ                                                                  โ
โ  if (!result.success) {                                         โ
โ    req.http.res.status(result.status || 500)                    โ
โ  }                                                               โ
โ  else if (ProcessType === 'AddMany') {                          โ
โ    req.http.res.status(201)                                     โ
โ    req.http.res.set('X-Created-Count', count)                   โ
โ  }                                                               โ
โ  else {                                                          โ
โ    req.http.res.status(200)                                     โ
โ  }                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 11: Enriquecer con Metadata                               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                               โ
โ                                                                  โ
โ  result._metadata = {                                           โ
โ    processType: ProcessType,                                    โ
โ    dbServer: DBServer,                                          โ
โ    loggedUser: LoggedUser,                                      โ
โ    method: method,                                              โ
โ    api: api,                                                    โ
โ    timestamp: new Date().toISOString()                          โ
โ  }                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      RESPONSE TO CLIENT                          โ
โ                                                                  โ
โ  {                                                               โ
โ    success: true,                                               โ
โ    status: 200,                                                 โ
โ    bitacora: [ /* ... */ ],                                     โ
โ    _metadata: {                                                 โ
โ      processType: 'GetFilters',                                 โ
โ      dbServer: 'MongoDB',                                       โ
โ      loggedUser: 'jlopezm',                                     โ
โ      method: 'POST',                                            โ
โ      api: '/api/ztpromociones/crudPromociones',                 โ
โ      timestamp: '2025-10-19T12:30:00.000Z'                      โ
โ    }                                                             โ
โ  }                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ Puntos Clave de Validaciรณn

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  CAMPOS BASE OBLIGATORIOS                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ                                                                โ
โ  โ processType   โ Query String (obligatorio)                โ
โ  โ LoggedUser    โ Query String (obligatorio, formato validado)โ
โ  โ๏ธ  DBServer     โ Query String (opcional, default: MongoDB) โ
โ  โ method        โ Autoconfigurado desde req                 โ
โ  โ api           โ Hardcoded en controller                   โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Validaciones por Capa

### Controller Layer
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  VALIDACIONES EN CONTROLLER         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  1. ProcessType presente            โ
โ  2. LoggedUser presente             โ
โ  3. Formato de LoggedUser           โ
โ  4. ProcessType vรกlido              โ
โ  5. DBServer vรกlido                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Service Layer
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  VALIDACIONES EN SERVICE            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  1. ProcessType en switch           โ
โ  2. DBServer en switch              โ
โ  3. Payload segรบn ProcessType       โ
โ  4. Campos obligatorios del modelo  โ
โ  5. Conexiรณn a base de datos        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Cรณdigos HTTP por Escenario

```
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Escenario           โ Cรณdigo   โ Descripciรณn                   โ
โโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ GetFilters OK       โ 200      โ Consulta exitosa              โ
โ AddMany OK          โ 201      โ Recursos creados              โ
โ UpdateMany OK       โ 200      โ Actualizaciรณn exitosa         โ
โ DeleteMany OK       โ 200      โ Eliminaciรณn exitosa           โ
โ Falta ProcessType   โ 400      โ Bad Request                   โ
โ Falta LoggedUser    โ 400      โ Bad Request                   โ
โ ProcessType invรกlidoโ 400      โ Bad Request                   โ
โ DBServer invรกlido   โ 400      โ Bad Request                   โ
โ Error de conexiรณn   โ 500      โ Internal Server Error         โ
โ Error de negocio    โ 500      โ Internal Server Error         โ
โโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Tipos de Respuesta

### โ Respuesta Exitosa (200/201)
```json
{
  "success": true,
  "status": 200,
  "bitacora": [
    {
      "process": "...",
      "processType": "GetFilters",
      "loggedUser": "jlopezm",
      "dbServer": "MongoDB",
      "server": "SAP-SERVER-01",
      "messageUSR": "...",
      "messageDEV": "...",
      "dataRes": [ /* ... */ ]
    }
  ],
  "_metadata": {
    "processType": "GetFilters",
    "dbServer": "MongoDB",
    "loggedUser": "jlopezm",
    "method": "POST",
    "api": "/api/ztpromociones/crudPromociones",
    "timestamp": "2025-10-19T12:30:00.000Z"
  }
}
```

### โ Respuesta de Error (400/500)
```json
{
  "success": false,
  "status": 400,
  "bitacora": [
    {
      "process": "Validaciรณn de parรกmetros",
      "messageUSR": "Falta parรกmetro: ProcessType",
      "messageDEV": "Valores vรกlidos: GetFilters, AddMany, UpdateMany, DeleteMany"
    }
  ],
  "_metadata": {
    "processType": null,
    "dbServer": "MongoDB",
    "loggedUser": null,
    "method": "POST",
    "api": "/api/ztpromociones/crudPromociones",
    "timestamp": "2025-10-19T12:30:00.000Z"
  }
}
```

---

## ๐งฉ Componentes del Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        ARQUITECTURA                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโ
โ                 โ      โ                 โ      โ             โ
โ  ROUTER (.cds)  โโโโโโโถโ  CONTROLLER     โโโโโโโถโ  SERVICE    โ
โ                 โ      โ                 โ      โ             โ
โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโ
                                โ                        โ
                                โ                        โ
                                โผ                        โผ
                         โโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ
                         โ             โ      โ                  โ
                         โ  VALIDATION โ      โ  DATABASE LAYER  โ
                         โ             โ      โ  (MongoDB/HANA)  โ
                         โโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ
                                                        โ
                                                        โผ
                                              โโโโโโโโโโโโโโโโโโโโ
                                              โ                  โ
                                              โ  AUDIT HELPER    โ
                                              โ  (saveWithAudit) โ
                                              โโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Checklist de Implementaciรณn

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ANTES DE HACER COMMIT                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  [ ] ProcessType validado en controller                         โ
โ  [ ] LoggedUser validado en controller                          โ
โ  [ ] Formato de LoggedUser verificado (regex)                   โ
โ  [ ] DBServer configurado (default: MongoDB)                    โ
โ  [ ] method y api autoconfigurados                              โ
โ  [ ] Bitรกcora incluye todos los campos base                     โ
โ  [ ] _metadata agregado en respuesta                            โ
โ  [ ] HTTP status configurados (200, 201, 400, 500)              โ
โ  [ ] Headers personalizados (X-Created-Count, etc.)             โ
โ  [ ] Logs de contexto en desarrollo                             โ
โ  [ ] Errores con cรณdigos correctos                              โ
โ  [ ] Documentado en router (.cds)                               โ
โ  [ ] Probado con Postman/REST Client                            โ
โ  [ ] Sin errores de ESLint                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Beneficios de la Estructura

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         BENEFICIOS                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ                                                                   โ
โ  ๐ TRAZABILIDAD                                                 โ
โ     Cada operaciรณn registra: quiรฉn, cuรกndo, quรฉ, dรณnde           โ
โ                                                                   โ
โ  โ VALIDACIรN TEMPRANA                                          โ
โ     Errores detectados en controller antes de llegar al service  โ
โ                                                                   โ
โ  ๐ DEBUGGING FACILITADO                                         โ
โ     Logs estructurados solo en desarrollo                        โ
โ                                                                   โ
โ  ๐ AUDITORรA AUTOMรTICA                                         โ
โ     Metadatos en cada respuesta para tracking                    โ
โ                                                                   โ
โ  ๐ MULTI-BD READY                                               โ
โ     DBServer configurable desde query string                     โ
โ                                                                   โ
โ  ๐ CONSISTENCIA                                                 โ
โ     Misma estructura en todos los endpoints                      โ
โ                                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**รltima actualizaciรณn**: 2025-10-19  
**Versiรณn**: 1.0.0  
**Autor**: Equipo Back-CDS
